name: ðŸš€ Simple Multi-Workflow Deployment

# MANUAL EXECUTION ONLY - Deploy selected workflows
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      workflows_to_deploy:
        description: 'Workflows to Deploy (comma-separated: 1,2,3,4,5,6,7)'
        required: true
        default: '2,3,4,5,6,7'
        type: string
      confirm_deployment:
        description: 'Type "DEPLOY-ALL" to confirm deployment'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  TF_VERSION: '1.6.0'
  AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

jobs:
  validate-and-deploy:
    name: ðŸš€ Deploy Selected Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 180
    environment: ${{ inputs.environment }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Validate Inputs
        run: |
          # Validate confirmation
          if [[ "${{ inputs.confirm_deployment }}" != "DEPLOY-ALL" ]]; then
            echo "âŒ Deployment requires 'DEPLOY-ALL' confirmation"
            exit 1
          fi
          
          # Parse workflows
          workflows="${{ inputs.workflows_to_deploy }}"
          workflows=$(echo "$workflows" | tr -d ' ')
          echo "âœ… Will deploy workflows: $workflows"
          
          # Create workflow flags
          echo "DEPLOY_1=false" >> $GITHUB_ENV
          echo "DEPLOY_2=false" >> $GITHUB_ENV
          echo "DEPLOY_3=false" >> $GITHUB_ENV
          echo "DEPLOY_4=false" >> $GITHUB_ENV
          echo "DEPLOY_5=false" >> $GITHUB_ENV
          echo "DEPLOY_6=false" >> $GITHUB_ENV
          echo "DEPLOY_7=false" >> $GITHUB_ENV
          
          IFS=',' read -ra WORKFLOW_ARRAY <<< "$workflows"
          for wf in "${WORKFLOW_ARRAY[@]}"; do
            case $wf in
              1) echo "DEPLOY_1=true" >> $GITHUB_ENV ;;
              2) echo "DEPLOY_2=true" >> $GITHUB_ENV ;;
              3) echo "DEPLOY_3=true" >> $GITHUB_ENV ;;
              4) echo "DEPLOY_4=true" >> $GITHUB_ENV ;;
              5) echo "DEPLOY_5=true" >> $GITHUB_ENV ;;
              6) echo "DEPLOY_6=true" >> $GITHUB_ENV ;;
              7) echo "DEPLOY_7=true" >> $GITHUB_ENV ;;
            esac
          done

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-SimpleDeployment

      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ðŸ—ï¸ Deploy Workflow 1 - Foundation Platform
        if: env.DEPLOY_1 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸ—ï¸ Deploying Foundation Platform..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.foundation -target=module.observability_irsa_roles -target=aws_iam_policy.observability_s3_policy
          terraform apply -auto-approve tfplan
          echo "âœ… Foundation Platform deployed!"

      - name: ðŸŒ Deploy Workflow 2 - Ingress + API Gateway
        if: env.DEPLOY_2 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸŒ Deploying Ingress + API Gateway..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.ingress
          terraform apply -auto-approve tfplan
          
          # Get cluster name and configure kubectl
          cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "")
          if [[ -n "$cluster_name" ]]; then
            aws eks update-kubeconfig --name "$cluster_name" --region ${{ secrets.AWS_REGION }}
            
            # Wait for Ambassador CRDs
            echo "â³ Waiting for Ambassador CRDs..."
            max_attempts=30
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              if kubectl get crd modules.getambassador.io hosts.getambassador.io mappings.getambassador.io 2>/dev/null; then
                echo "âœ… Ambassador CRDs are ready"
                break
              fi
              echo "â³ Waiting for Ambassador CRDs... ($attempt/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            done
            
            # Verify components
            kubectl wait --for=condition=available --timeout=300s deployment/ambassador -n ingress-system || true
            kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n ingress-system || true
          fi
          echo "âœ… Ingress + API Gateway deployed!"

      - name: ðŸ“ˆ Deploy Workflow 3 - LGTM Observability
        if: env.DEPLOY_3 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸ“ˆ Deploying LGTM Observability..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.lgtm_observability
          terraform apply -auto-approve tfplan
          
          # Get cluster name and verify
          cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "")
          if [[ -n "$cluster_name" ]]; then
            aws eks update-kubeconfig --name "$cluster_name" --region ${{ secrets.AWS_REGION }}
            sleep 120
            kubectl wait --for=condition=available --timeout=600s deployment/prometheus-server -n observability || true
            kubectl wait --for=condition=available --timeout=300s deployment/grafana -n observability || true
          fi
          echo "âœ… LGTM Observability deployed!"

      - name: ðŸ”„ Deploy Workflow 4 - GitOps & Deployment Automation
        if: env.DEPLOY_4 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸ”„ Deploying GitOps & Deployment Automation..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.gitops
          terraform apply -auto-approve tfplan
          
          # Get cluster name and verify
          cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "")
          if [[ -n "$cluster_name" ]]; then
            aws eks update-kubeconfig --name "$cluster_name" --region ${{ secrets.AWS_REGION }}
            sleep 180
            kubectl wait --for=condition=available --timeout=600s deployment/argocd-server -n argocd || true
          fi
          echo "âœ… GitOps & Deployment Automation deployed!"

      - name: ðŸ” Deploy Workflow 5 - Security Foundation
        if: env.DEPLOY_5 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸ” Deploying Security Foundation..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.security
          terraform apply -auto-approve tfplan
          
          # Get cluster name and verify
          cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "")
          if [[ -n "$cluster_name" ]]; then
            aws eks update-kubeconfig --name "$cluster_name" --region ${{ secrets.AWS_REGION }}
            sleep 120
            kubectl wait --for=condition=available --timeout=300s deployment/gatekeeper-controller-manager -n gatekeeper-system || true
          fi
          echo "âœ… Security Foundation deployed!"

      - name: ðŸ›¡ï¸ Deploy Workflow 6 - Service Mesh
        if: env.DEPLOY_6 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸ›¡ï¸ Deploying Service Mesh..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.service_mesh
          terraform apply -auto-approve tfplan
          
          # Get cluster name and verify
          cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "")
          if [[ -n "$cluster_name" ]]; then
            aws eks update-kubeconfig --name "$cluster_name" --region ${{ secrets.AWS_REGION }}
            sleep 180
            kubectl wait --for=condition=available --timeout=600s deployment/istiod -n istio-system || true
          fi
          echo "âœ… Service Mesh deployed!"

      - name: ðŸ“Š Deploy Workflow 7 - Data Services
        if: env.DEPLOY_7 == 'true'
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ðŸ“Š Deploying Data Services..."
          terraform init -backend-config="key=eks-platform/${{ inputs.environment }}/terraform.tfstate"
          terraform plan -out=tfplan -target=module.data_services
          terraform apply -auto-approve tfplan
          
          # Get cluster name and verify
          cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "")
          if [[ -n "$cluster_name" ]]; then
            aws eks update-kubeconfig --name "$cluster_name" --region ${{ secrets.AWS_REGION }}
            sleep 120
            kubectl wait --for=condition=ready --timeout=600s pod -l app=postgresql -n data-services || true
          fi
          echo "âœ… Data Services deployed!"

      - name: ðŸ“‹ Generate Deployment Summary
        run: |
          echo "## ðŸš€ Simple Multi-Workflow Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflows Requested**: ${{ inputs.workflows_to_deploy }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Results:**" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ env.DEPLOY_1 }}" == "true" ]]; then
            echo "- ðŸ—ï¸ **Foundation Platform**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ env.DEPLOY_2 }}" == "true" ]]; then
            echo "- ðŸŒ **Ingress + API Gateway**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ env.DEPLOY_3 }}" == "true" ]]; then
            echo "- ðŸ“ˆ **LGTM Observability**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ env.DEPLOY_4 }}" == "true" ]]; then
            echo "- ðŸ”„ **GitOps & Deployment**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ env.DEPLOY_5 }}" == "true" ]]; then
            echo "- ðŸ” **Security Foundation**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ env.DEPLOY_6 }}" == "true" ]]; then
            echo "- ðŸ›¡ï¸ **Service Mesh**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ env.DEPLOY_7 }}" == "true" ]]; then
            echo "- ðŸ“Š **Data Services**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All requested workflows have been deployed successfully!**" >> $GITHUB_STEP_SUMMARY