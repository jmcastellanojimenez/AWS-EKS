#!/bin/bash
set -euo pipefail

# Cost Estimation Script
# Provides detailed cost analysis for the EKS learning lab

ENVIRONMENT=${1:-dev}
REGION=${2:-us-east-1}
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
}

info() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')] INFO: $1${NC}"
}

highlight() {
    echo -e "${CYAN}$1${NC}"
}

# Cost calculation functions
calculate_eks_costs() {
    local environment=$1
    
    case $environment in
        "dev")
            # Development environment costs
            EKS_CLUSTER_HOURLY=0.10
            EC2_INSTANCES=1
            INSTANCE_TYPE="t3.medium"
            INSTANCE_HOURLY_ONDEMAND=0.0416
            INSTANCE_HOURLY_SPOT=0.0125  # ~70% savings
            EBS_STORAGE_GB=20
            NAT_GATEWAY=0  # Disabled for cost savings
            ;;
        "staging")
            # Staging environment costs
            EKS_CLUSTER_HOURLY=0.10
            EC2_INSTANCES=2
            INSTANCE_TYPE="t3.medium"
            INSTANCE_HOURLY_ONDEMAND=0.0416
            INSTANCE_HOURLY_SPOT=0.0125
            EBS_STORAGE_GB=40
            NAT_GATEWAY=1
            ;;
        "prod")
            # Production environment costs
            EKS_CLUSTER_HOURLY=0.10
            EC2_INSTANCES=3
            INSTANCE_TYPE="t3.medium"
            INSTANCE_HOURLY_ONDEMAND=0.0416
            INSTANCE_HOURLY_SPOT=0.0125
            EBS_STORAGE_GB=60
            NAT_GATEWAY=2
            ;;
        *)
            error "Unknown environment: $environment"
            exit 1
            ;;
    esac
    
    # Calculate monthly costs (24 hours * 30 days = 720 hours)
    local hours_per_month=720
    
    # EKS Control Plane
    EKS_MONTHLY=$(echo "scale=2; $EKS_CLUSTER_HOURLY * $hours_per_month" | bc)
    
    # EC2 Instances (Spot pricing)
    EC2_MONTHLY=$(echo "scale=2; $INSTANCE_HOURLY_SPOT * $EC2_INSTANCES * $hours_per_month" | bc)
    EC2_ONDEMAND_MONTHLY=$(echo "scale=2; $INSTANCE_HOURLY_ONDEMAND * $EC2_INSTANCES * $hours_per_month" | bc)
    
    # EBS Storage (GP3)
    EBS_MONTHLY=$(echo "scale=2; $EBS_STORAGE_GB * 0.08" | bc)  # $0.08 per GB/month
    
    # NAT Gateway
    if [ $NAT_GATEWAY -gt 0 ]; then
        NAT_MONTHLY=$(echo "scale=2; $NAT_GATEWAY * 45.0" | bc)  # $45/month per NAT Gateway
        NAT_DATA_PROCESSING=5.0  # Estimated data processing costs
    else
        NAT_MONTHLY=0
        NAT_DATA_PROCESSING=0
    fi
    
    # Application Load Balancer (if using ALB)
    ALB_MONTHLY=16.20  # $0.0225/hour
    
    # Data Transfer
    DATA_TRANSFER_MONTHLY=2.0  # Estimated inter-AZ data transfer
    
    # CloudWatch Logs
    CLOUDWATCH_LOGS=3.0  # Estimated log ingestion and storage
    
    # Total
    TOTAL_MONTHLY=$(echo "scale=2; $EKS_MONTHLY + $EC2_MONTHLY + $EBS_MONTHLY + $NAT_MONTHLY + $NAT_DATA_PROCESSING + $ALB_MONTHLY + $DATA_TRANSFER_MONTHLY + $CLOUDWATCH_LOGS" | bc)
    TOTAL_ONDEMAND=$(echo "scale=2; $EKS_MONTHLY + $EC2_ONDEMAND_MONTHLY + $EBS_MONTHLY + $NAT_MONTHLY + $NAT_DATA_PROCESSING + $ALB_MONTHLY + $DATA_TRANSFER_MONTHLY + $CLOUDWATCH_LOGS" | bc)
    
    # Savings
    SPOT_SAVINGS=$(echo "scale=2; $TOTAL_ONDEMAND - $TOTAL_MONTHLY" | bc)
}

# Print detailed cost breakdown
print_cost_breakdown() {
    local environment=$1
    
    echo ""
    highlight "===================================================="
    highlight "      EKS Learning Lab - Cost Breakdown"
    highlight "===================================================="
    echo ""
    
    info "Environment: $(echo $environment | tr '[:lower:]' '[:upper:]')"
    info "Region: $REGION"
    info "Instance Type: $INSTANCE_TYPE (Spot instances)"
    info "Instance Count: $EC2_INSTANCES"
    echo ""
    
    highlight "Monthly Cost Breakdown:"
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    echo "‚îÇ Service                         ‚îÇ Monthly Cost ‚îÇ"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
    printf "‚îÇ EKS Control Plane               ‚îÇ %12s ‚îÇ\n" "\$$EKS_MONTHLY"
    printf "‚îÇ EC2 Instances (Spot)            ‚îÇ %12s ‚îÇ\n" "\$$EC2_MONTHLY"
    printf "‚îÇ EBS Storage (${EBS_STORAGE_GB}GB GP3)          ‚îÇ %12s ‚îÇ\n" "\$$EBS_MONTHLY"
    if [ $NAT_GATEWAY -gt 0 ]; then
        printf "‚îÇ NAT Gateway ($NAT_GATEWAY)                  ‚îÇ %12s ‚îÇ\n" "\$$NAT_MONTHLY"
        printf "‚îÇ NAT Data Processing             ‚îÇ %12s ‚îÇ\n" "\$$NAT_DATA_PROCESSING"
    else
        printf "‚îÇ NAT Gateway (Disabled)          ‚îÇ %12s ‚îÇ\n" "\$0.00"
    fi
    printf "‚îÇ Application Load Balancer       ‚îÇ %12s ‚îÇ\n" "\$$ALB_MONTHLY"
    printf "‚îÇ Data Transfer                   ‚îÇ %12s ‚îÇ\n" "\$$DATA_TRANSFER_MONTHLY"
    printf "‚îÇ CloudWatch Logs                 ‚îÇ %12s ‚îÇ\n" "\$$CLOUDWATCH_LOGS"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
    printf "‚îÇ TOTAL (Spot instances)          ‚îÇ %12s ‚îÇ\n" "\$$TOTAL_MONTHLY"
    printf "‚îÇ TOTAL (On-Demand)               ‚îÇ %12s ‚îÇ\n" "\$$TOTAL_ONDEMAND"
    printf "‚îÇ Monthly Savings (Spot)          ‚îÇ %12s ‚îÇ\n" "\$$SPOT_SAVINGS"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
}

# Calculate additional cost optimizations
print_cost_optimizations() {
    local environment=$1
    
    highlight "Cost Optimization Strategies:"
    echo ""
    
    info "‚úÖ Already Implemented:"
    echo "  ‚Ä¢ Spot instances (70% savings on compute)"
    if [ $NAT_GATEWAY -eq 0 ]; then
        echo "  ‚Ä¢ No NAT Gateway (saves ~\$45/month)"
    fi
    echo "  ‚Ä¢ GP3 EBS volumes (20% cheaper than GP2)"
    echo "  ‚Ä¢ Right-sized instances for learning workloads"
    echo "  ‚Ä¢ Automated shutdown scheduling"
    echo ""
    
    info "üí° Additional Savings Opportunities:"
    echo "  ‚Ä¢ Scheduled cluster shutdown (evenings/weekends)"
    echo "    - 12 hours/day = 50% savings (\$$(echo "scale=0; $TOTAL_MONTHLY / 2" | bc)/month)"
    echo "    - Weekend shutdown = 28% savings (\$$(echo "scale=0; $TOTAL_MONTHLY * 0.28" | bc)/month)"
    echo "  ‚Ä¢ Use smaller instances for non-production workloads"
    echo "  ‚Ä¢ Enable AWS Compute Savings Plans for 1-3 year commitment"
    echo "  ‚Ä¢ Use AWS Free Tier resources where possible"
    echo ""
    
    # Calculate potential savings with scheduled shutdown
    EVENING_SAVINGS=$(echo "scale=2; $TOTAL_MONTHLY * 0.5" | bc)
    WEEKEND_SAVINGS=$(echo "scale=2; $TOTAL_MONTHLY * 0.28" | bc)
    COMBINED_SAVINGS=$(echo "scale=2; $TOTAL_MONTHLY * 0.65" | bc)
    
    highlight "Automated Shutdown Savings:"
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    echo "‚îÇ Shutdown Schedule               ‚îÇ Monthly Cost ‚îÇ"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
    printf "‚îÇ No shutdown (24/7)             ‚îÇ %12s ‚îÇ\n" "\$$TOTAL_MONTHLY"
    printf "‚îÇ Evening shutdown (12hrs/day)   ‚îÇ %12s ‚îÇ\n" "\$$EVENING_SAVINGS"
    printf "‚îÇ Weekend shutdown (5days/week)  ‚îÇ %12s ‚îÇ\n" "\$$WEEKEND_SAVINGS"
    printf "‚îÇ Combined (evening + weekend)   ‚îÇ %12s ‚îÇ\n" "\$$COMBINED_SAVINGS"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
}

# Print budget recommendations
print_budget_recommendations() {
    local environment=$1
    
    highlight "Budget Recommendations:"
    echo ""
    
    case $environment in
        "dev")
            RECOMMENDED_BUDGET=75
            ALERT_THRESHOLD=60
            ;;
        "staging")
            RECOMMENDED_BUDGET=150
            ALERT_THRESHOLD=120
            ;;
        "prod")
            RECOMMENDED_BUDGET=300
            ALERT_THRESHOLD=250
            ;;
    esac
    
    info "Environment: $environment"
    echo "  ‚Ä¢ Recommended monthly budget: \$$RECOMMENDED_BUDGET"
    echo "  ‚Ä¢ Set budget alerts at: \$$ALERT_THRESHOLD (80%)"
    echo "  ‚Ä¢ Current estimated cost: \$$TOTAL_MONTHLY"
    
    if (( $(echo "$TOTAL_MONTHLY > $RECOMMENDED_BUDGET" | bc -l) )); then
        warn "‚ö†Ô∏è  Estimated cost exceeds recommended budget!"
        echo "     Consider implementing cost optimization strategies."
    else
        log "‚úÖ Estimated cost is within recommended budget."
    fi
    echo ""
}

# Print monitoring and alerts setup
print_monitoring_setup() {
    highlight "Cost Monitoring Setup:"
    echo ""
    
    info "AWS Cost Management:"
    echo "  ‚Ä¢ Set up AWS Budgets with email alerts"
    echo "  ‚Ä¢ Enable Cost Anomaly Detection"
    echo "  ‚Ä¢ Use AWS Cost Explorer for detailed analysis"
    echo "  ‚Ä¢ Tag all resources for cost allocation"
    echo ""
    
    info "GitHub Actions Integration:"
    echo "  ‚Ä¢ Daily cost monitoring workflow"
    echo "  ‚Ä¢ Pre-deployment cost estimation"
    echo "  ‚Ä¢ Automated budget alerts"
    echo "  ‚Ä¢ Resource cleanup automation"
    echo ""
    
    info "Useful Commands:"
    echo "  ‚Ä¢ Get current costs: aws ce get-cost-and-usage"
    echo "  ‚Ä¢ List active resources: aws resourcegroupstaggingapi get-resources"
    echo "  ‚Ä¢ Check spot instance savings: aws ec2 describe-spot-price-history"
    echo ""
}

# Print comparison table
print_environment_comparison() {
    highlight "Environment Cost Comparison:"
    echo ""
    
    # Calculate costs for all environments
    calculate_eks_costs "dev"
    DEV_COST=$TOTAL_MONTHLY
    
    calculate_eks_costs "staging"
    STAGING_COST=$TOTAL_MONTHLY
    
    calculate_eks_costs "prod"
    PROD_COST=$TOTAL_MONTHLY
    
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    echo "‚îÇ Component   ‚îÇ Development  ‚îÇ Staging      ‚îÇ Production   ‚îÇ"
    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
    echo "‚îÇ Instances   ‚îÇ 1 √ó t3.medium ‚îÇ 2 √ó t3.medium ‚îÇ 3 √ó t3.medium‚îÇ"
    echo "‚îÇ Capacity    ‚îÇ Spot         ‚îÇ Spot         ‚îÇ On-Demand    ‚îÇ"
    echo "‚îÇ NAT Gateway ‚îÇ No           ‚îÇ Yes (1)      ‚îÇ Yes (2)      ‚îÇ"
    echo "‚îÇ Storage     ‚îÇ 20GB         ‚îÇ 40GB         ‚îÇ 60GB         ‚îÇ"
    printf "‚îÇ Total Cost  ‚îÇ %12s ‚îÇ %12s ‚îÇ %12s ‚îÇ\n" "\$$DEV_COST" "\$$STAGING_COST" "\$$PROD_COST"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
    
    # Restore original environment calculation
    calculate_eks_costs $ENVIRONMENT
}

# Main execution
main() {
    log "Calculating costs for EKS Learning Lab environment: $ENVIRONMENT"
    
    # Check if bc is available for calculations
    if ! command -v bc &> /dev/null; then
        error "bc (calculator) is required but not installed"
        info "Install with: sudo apt-get install bc (Ubuntu/Debian) or sudo yum install bc (RHEL/CentOS)"
        exit 1
    fi
    
    # Calculate costs
    calculate_eks_costs $ENVIRONMENT
    
    # Print detailed breakdown
    print_cost_breakdown $ENVIRONMENT
    print_cost_optimizations $ENVIRONMENT
    print_budget_recommendations $ENVIRONMENT
    print_monitoring_setup
    print_environment_comparison
    
    # Summary
    highlight "===================================================="
    highlight "                    SUMMARY"
    highlight "===================================================="
    echo ""
    log "Environment: $ENVIRONMENT"
    log "Estimated monthly cost: \$$TOTAL_MONTHLY (with optimizations)"
    log "Cost without optimizations: \$$TOTAL_ONDEMAND"
    log "Monthly savings: \$$SPOT_SAVINGS"
    echo ""
    
    if [ "$ENVIRONMENT" = "dev" ]; then
        info "üí° For maximum cost savings in development:"
        echo "  ‚Ä¢ Use scheduled shutdown: ./install-cost-control.sh"
        echo "  ‚Ä¢ Enable weekend shutdown: saves ~65% of compute costs"
        echo "  ‚Ä¢ Monitor usage with: aws ce get-cost-and-usage"
    fi
    
    echo ""
    log "Cost estimation completed successfully! üí∞"
}

# Run main function
main "$@"