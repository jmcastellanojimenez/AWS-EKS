# Tekton Pipelines Configuration
# Production-ready configuration for Java microservices CI/CD

## Tekton Pipelines Controller Configuration
pipelines:
  controller:
    replicas: 2
    
    # Resource configuration
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    
    # Configuration
    config:
      # Default timeout for pipeline runs
      default-timeout-minutes: "60"
      
      # Default service account
      default-service-account: "pipeline"
      
      # Default task run template
      default-task-run-workspace-binding: |
        emptyDir: {}
      
      # Feature flags
      enable-tekton-oci-bundles: "true"
      enable-custom-tasks: "true"
      enable-api-fields: "stable"
      
      # Performance settings
      default-max-matrix-combinations-count: "256"
      default-forbidden-env: "TEKTON_*"
      
      # Resource requirements
      default-container-resource-requirements: |
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
  
  webhook:
    replicas: 2
    
    # Resource configuration
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

## Tekton Triggers Configuration
triggers:
  controller:
    replicas: 2
    
    # Resource configuration
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
  
  webhook:
    replicas: 2
    
    # Resource configuration
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
    
    # Service configuration for webhook access
    service:
      type: ClusterIP
      port: 8080
      annotations:
        getambassador.io/config: |
          ---
          apiVersion: getambassador.io/v3alpha1
          kind: Mapping
          name: tekton-webhooks
          prefix: /tekton-webhooks
          service: tekton-triggers-webhook:8080
          timeout_ms: 30000
          retry_policy:
            retry_on: "5xx"
            num_retries: 3
          rewrite: /

## Tekton Dashboard Configuration
dashboard:
  enabled: true
  replicas: 2
  
  # Resource configuration
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  # Service configuration
  service:
    type: ClusterIP
    port: 9097
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "9097"
      prometheus.io/path: "/metrics"
  
  # Ingress configuration for Ambassador
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: "ambassador"
      getambassador.io/config: |
        ---
        apiVersion: getambassador.io/v3alpha1
        kind: Mapping
        name: tekton-dashboard
        prefix: /
        service: tekton-dashboard:9097
        host: ${TEKTON_DOMAIN:-tekton.local}
        timeout_ms: 30000
        ---
        apiVersion: getambassador.io/v3alpha1
        kind: TLSContext
        name: tekton-tls
        hosts:
        - ${TEKTON_DOMAIN:-tekton.local}
        secret: tekton-tls-secret
    hosts:
      - ${TEKTON_DOMAIN:-tekton.local}
    tls:
      - secretName: tekton-tls-secret
        hosts:
          - ${TEKTON_DOMAIN:-tekton.local}

## Monitoring Configuration
monitoring:
  enabled: true
  
  # Prometheus ServiceMonitor for Tekton components
  serviceMonitor:
    enabled: true
    namespace: observability
    additionalLabels:
      monitoring: lgtm-stack
    endpoints:
      - port: http-metrics
        interval: 30s
        path: /metrics

## Security Configuration
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001
  seccompProfile:
    type: RuntimeDefault

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

## Node Configuration
nodeSelector:
  kubernetes.io/os: linux

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/component
            operator: In
            values:
            - controller
            - webhook
        topologyKey: kubernetes.io/hostname

## Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

## Additional Configuration
podLabels:
  app.kubernetes.io/part-of: gitops-platform
  monitoring: lgtm-stack

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"