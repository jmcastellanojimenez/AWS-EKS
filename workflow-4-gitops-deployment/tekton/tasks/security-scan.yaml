apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: security-scan
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/version: "0.1"
    app.kubernetes.io/part-of: gitops-platform
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Security
    tekton.dev/tags: security, vulnerability, trivy, scan
    tekton.dev/displayName: "Security Vulnerability Scan"
    tekton.dev/platforms: "linux/amd64,linux/arm64"
spec:
  description: >-
    This task performs comprehensive security scanning using Trivy,
    including vulnerability scanning, secret detection, and compliance checks.

  params:
    - name: IMAGE
      description: Container image to scan
      type: string
    - name: SCAN_TYPE
      description: Type of scan (image, fs, repo, config)
      type: string
      default: "image"
    - name: FORMAT
      description: Output format (table, json, sarif, cyclonedx, spdx)
      type: string
      default: "table"
    - name: SEVERITY
      description: Severity levels to report
      type: string
      default: "HIGH,CRITICAL"
    - name: EXIT_CODE
      description: Exit code when vulnerabilities are found (0 or 1)
      type: string
      default: "0"
    - name: IGNORE_UNFIXED
      description: Ignore unfixed vulnerabilities
      type: string
      default: "false"
    - name: SKIP_DB_UPDATE
      description: Skip vulnerability database update
      type: string
      default: "false"
    - name: TIMEOUT
      description: Scan timeout
      type: string
      default: "10m"
    - name: CACHE_DIR
      description: Cache directory for Trivy
      type: string
      default: "/tmp/trivy-cache"
    - name: SECRET_SCAN
      description: Enable secret scanning
      type: string
      default: "true"
    - name: CONFIG_SCAN
      description: Enable configuration scanning
      type: string
      default: "true"
    - name: COMPLIANCE_STANDARDS
      description: Compliance standards to check
      type: string
      default: "docker-cis"

  workspaces:
    - name: source
      description: Workspace containing source code (for fs/repo scans)
      optional: true
    - name: reports
      description: Workspace to store scan reports
      optional: true

  results:
    - name: SCAN_RESULT
      description: Overall scan result (PASS/FAIL)
    - name: VULNERABILITY_COUNT
      description: Number of vulnerabilities found
    - name: CRITICAL_COUNT
      description: Number of critical vulnerabilities
    - name: HIGH_COUNT
      description: Number of high severity vulnerabilities

  steps:
    - name: setup-trivy
      image: alpine:3.18
      script: |
        #!/bin/sh
        set -e
        
        echo "üîß Setting up Trivy scanner..."
        
        # Create cache directory
        mkdir -p "$(params.CACHE_DIR)"
        
        # Validate scan parameters
        case "$(params.SCAN_TYPE)" in
          image|fs|repo|config)
            echo "‚úÖ Valid scan type: $(params.SCAN_TYPE)"
            ;;
          *)
            echo "‚ùå Invalid scan type: $(params.SCAN_TYPE)"
            exit 1
            ;;
        esac
        
        echo "üìã Scan Configuration:"
        echo "  Type: $(params.SCAN_TYPE)"
        echo "  Target: $(params.IMAGE)"
        echo "  Format: $(params.FORMAT)"
        echo "  Severity: $(params.SEVERITY)"
        echo "  Exit Code: $(params.EXIT_CODE)"
        echo "  Timeout: $(params.TIMEOUT)"
        
        echo "‚úÖ Trivy setup complete"

    - name: vulnerability-scan
      image: aquasec/trivy:0.49.1
      env:
        - name: TRIVY_CACHE_DIR
          value: "$(params.CACHE_DIR)"
        - name: TRIVY_NO_PROGRESS
          value: "true"
        - name: TRIVY_TIMEOUT
          value: "$(params.TIMEOUT)"
      script: |
        #!/bin/sh
        set -e
        
        echo "üîç Starting vulnerability scan..."
        
        # Prepare scan target
        SCAN_TARGET=""
        case "$(params.SCAN_TYPE)" in
          image)
            SCAN_TARGET="$(params.IMAGE)"
            echo "üì¶ Scanning container image: $SCAN_TARGET"
            ;;
          fs)
            SCAN_TARGET="$(workspaces.source.path)"
            echo "üìÅ Scanning filesystem: $SCAN_TARGET"
            ;;
          repo)
            SCAN_TARGET="$(workspaces.source.path)"
            echo "üìÇ Scanning repository: $SCAN_TARGET"
            ;;
          config)
            SCAN_TARGET="$(workspaces.source.path)"
            echo "‚öôÔ∏è Scanning configuration: $SCAN_TARGET"
            ;;
        esac
        
        # Prepare trivy command
        TRIVY_CMD="trivy $(params.SCAN_TYPE)"
        
        # Add common options
        TRIVY_CMD="$TRIVY_CMD --format $(params.FORMAT)"
        TRIVY_CMD="$TRIVY_CMD --severity $(params.SEVERITY)"
        TRIVY_CMD="$TRIVY_CMD --exit-code $(params.EXIT_CODE)"
        
        # Add conditional options
        if [ "$(params.IGNORE_UNFIXED)" = "true" ]; then
          TRIVY_CMD="$TRIVY_CMD --ignore-unfixed"
        fi
        
        if [ "$(params.SKIP_DB_UPDATE)" = "true" ]; then
          TRIVY_CMD="$TRIVY_CMD --skip-db-update"
        fi
        
        # Execute scan
        echo "üöÄ Executing: $TRIVY_CMD $SCAN_TARGET"
        
        # Capture output for processing
        SCAN_OUTPUT="/tmp/scan-output.txt"
        $TRIVY_CMD "$SCAN_TARGET" | tee "$SCAN_OUTPUT" || SCAN_EXIT_CODE=$?
        
        # Process scan results
        if [ -f "$SCAN_OUTPUT" ]; then
          # Count vulnerabilities by severity
          CRITICAL_COUNT=$(grep -c "CRITICAL" "$SCAN_OUTPUT" || echo "0")
          HIGH_COUNT=$(grep -c "HIGH" "$SCAN_OUTPUT" || echo "0")
          MEDIUM_COUNT=$(grep -c "MEDIUM" "$SCAN_OUTPUT" || echo "0")
          LOW_COUNT=$(grep -c "LOW" "$SCAN_OUTPUT" || echo "0")
          
          TOTAL_VULNS=$((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))
          
          echo "üìä Vulnerability Summary:"
          echo "  Critical: $CRITICAL_COUNT"
          echo "  High: $HIGH_COUNT"
          echo "  Medium: $MEDIUM_COUNT"
          echo "  Low: $LOW_COUNT"
          echo "  Total: $TOTAL_VULNS"
          
          # Store results
          echo -n "$TOTAL_VULNS" > $(results.VULNERABILITY_COUNT.path)
          echo -n "$CRITICAL_COUNT" > $(results.CRITICAL_COUNT.path)
          echo -n "$HIGH_COUNT" > $(results.HIGH_COUNT.path)
          
          # Determine overall result
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo -n "FAIL" > $(results.SCAN_RESULT.path)
            echo "‚ùå Security scan FAILED - Critical or High vulnerabilities found"
          else
            echo -n "PASS" > $(results.SCAN_RESULT.path)
            echo "‚úÖ Security scan PASSED - No critical or high vulnerabilities"
          fi
        else
          echo "‚ö†Ô∏è Warning: Could not process scan output"
          echo -n "UNKNOWN" > $(results.SCAN_RESULT.path)
          echo -n "0" > $(results.VULNERABILITY_COUNT.path)
          echo -n "0" > $(results.CRITICAL_COUNT.path)
          echo -n "0" > $(results.HIGH_COUNT.path)
        fi
        
        # Copy output to reports workspace if available
        if [ -d "$(workspaces.reports.path)" ]; then
          cp "$SCAN_OUTPUT" "$(workspaces.reports.path)/vulnerability-scan.txt"
        fi

    - name: secret-scan
      image: aquasec/trivy:0.49.1
      when:
        - input: "$(params.SECRET_SCAN)"
          operator: in
          values: ["true", "True", "TRUE"]
      env:
        - name: TRIVY_CACHE_DIR
          value: "$(params.CACHE_DIR)"
        - name: TRIVY_NO_PROGRESS
          value: "true"
      script: |
        #!/bin/sh
        set -e
        
        echo "üîê Starting secret scan..."
        
        # Determine scan target
        if [ "$(params.SCAN_TYPE)" = "image" ]; then
          SCAN_TARGET="$(params.IMAGE)"
          SCAN_CMD="trivy image --scanners secret"
        else
          SCAN_TARGET="$(workspaces.source.path)"
          SCAN_CMD="trivy fs --scanners secret"
        fi
        
        echo "üîç Scanning for secrets in: $SCAN_TARGET"
        
        # Execute secret scan
        SECRET_OUTPUT="/tmp/secret-scan.txt"
        $SCAN_CMD --format table "$SCAN_TARGET" > "$SECRET_OUTPUT" || true
        
        # Display results
        if [ -s "$SECRET_OUTPUT" ]; then
          echo "üö® Secrets found:"
          cat "$SECRET_OUTPUT"
          
          # Copy to reports workspace
          if [ -d "$(workspaces.reports.path)" ]; then
            cp "$SECRET_OUTPUT" "$(workspaces.reports.path)/secret-scan.txt"
          fi
        else
          echo "‚úÖ No secrets detected"
        fi

    - name: config-scan
      image: aquasec/trivy:0.49.1
      when:
        - input: "$(params.CONFIG_SCAN)"
          operator: in
          values: ["true", "True", "TRUE"]
      env:
        - name: TRIVY_CACHE_DIR
          value: "$(params.CACHE_DIR)"
        - name: TRIVY_NO_PROGRESS
          value: "true"
      script: |
        #!/bin/sh
        set -e
        
        echo "‚öôÔ∏è Starting configuration scan..."
        
        # Only scan filesystem/repo for configuration issues
        if [ "$(params.SCAN_TYPE)" = "image" ]; then
          echo "‚ÑπÔ∏è Skipping config scan for image scan type"
          exit 0
        fi
        
        SCAN_TARGET="$(workspaces.source.path)"
        echo "üîç Scanning configuration in: $SCAN_TARGET"
        
        # Execute configuration scan
        CONFIG_OUTPUT="/tmp/config-scan.txt"
        trivy fs --scanners config \
          --format table \
          --severity HIGH,CRITICAL \
          "$SCAN_TARGET" > "$CONFIG_OUTPUT" || true
        
        # Display results
        if [ -s "$CONFIG_OUTPUT" ]; then
          echo "‚ö†Ô∏è Configuration issues found:"
          cat "$CONFIG_OUTPUT"
          
          # Copy to reports workspace
          if [ -d "$(workspaces.reports.path)" ]; then
            cp "$CONFIG_OUTPUT" "$(workspaces.reports.path)/config-scan.txt"
          fi
        else
          echo "‚úÖ No configuration issues detected"
        fi

    - name: compliance-check
      image: aquasec/trivy:0.49.1
      when:
        - input: "$(params.COMPLIANCE_STANDARDS)"
          operator: notin
          values: ["", "none"]
      env:
        - name: TRIVY_CACHE_DIR
          value: "$(params.CACHE_DIR)"
        - name: TRIVY_NO_PROGRESS
          value: "true"
      script: |
        #!/bin/sh
        set -e
        
        echo "üìã Starting compliance check..."
        echo "Standards: $(params.COMPLIANCE_STANDARDS)"
        
        # Execute compliance scan based on type
        COMPLIANCE_OUTPUT="/tmp/compliance-scan.txt"
        
        case "$(params.SCAN_TYPE)" in
          image)
            trivy image --compliance "$(params.COMPLIANCE_STANDARDS)" \
              --format table "$(params.IMAGE)" > "$COMPLIANCE_OUTPUT" || true
            ;;
          fs|repo)
            trivy fs --compliance "$(params.COMPLIANCE_STANDARDS)" \
              --format table "$(workspaces.source.path)" > "$COMPLIANCE_OUTPUT" || true
            ;;
          *)
            echo "‚ÑπÔ∏è Compliance check not supported for scan type: $(params.SCAN_TYPE)"
            exit 0
            ;;
        esac
        
        # Display results
        if [ -s "$COMPLIANCE_OUTPUT" ]; then
          echo "üìä Compliance check results:"
          cat "$COMPLIANCE_OUTPUT"
          
          # Copy to reports workspace
          if [ -d "$(workspaces.reports.path)" ]; then
            cp "$COMPLIANCE_OUTPUT" "$(workspaces.reports.path)/compliance-scan.txt"
          fi
        else
          echo "‚úÖ No compliance issues detected"
        fi

    - name: generate-sarif-report
      image: aquasec/trivy:0.49.1
      when:
        - input: "$(params.FORMAT)"
          operator: in
          values: ["sarif"]
      env:
        - name: TRIVY_CACHE_DIR
          value: "$(params.CACHE_DIR)"
        - name: TRIVY_NO_PROGRESS
          value: "true"
      script: |
        #!/bin/sh
        set -e
        
        echo "üìÑ Generating SARIF report..."
        
        SARIF_OUTPUT="/tmp/trivy-results.sarif"
        
        case "$(params.SCAN_TYPE)" in
          image)
            trivy image --format sarif \
              --severity "$(params.SEVERITY)" \
              --output "$SARIF_OUTPUT" \
              "$(params.IMAGE)"
            ;;
          fs|repo)
            trivy fs --format sarif \
              --severity "$(params.SEVERITY)" \
              --output "$SARIF_OUTPUT" \
              "$(workspaces.source.path)"
            ;;
        esac
        
        if [ -f "$SARIF_OUTPUT" ]; then
          echo "‚úÖ SARIF report generated"
          
          # Copy to reports workspace
          if [ -d "$(workspaces.reports.path)" ]; then
            cp "$SARIF_OUTPUT" "$(workspaces.reports.path)/trivy-results.sarif"
          fi
        fi

    - name: scan-summary
      image: alpine:3.18
      script: |
        #!/bin/sh
        set -e
        
        echo "üìã Security Scan Summary"
        echo "======================="
        echo "Scan Type: $(params.SCAN_TYPE)"
        echo "Target: $(params.IMAGE)"
        echo "Format: $(params.FORMAT)"
        echo "Severity Filter: $(params.SEVERITY)"
        echo "Secret Scan: $(params.SECRET_SCAN)"
        echo "Config Scan: $(params.CONFIG_SCAN)"
        echo "Compliance: $(params.COMPLIANCE_STANDARDS)"
        
        if [ -f "$(results.SCAN_RESULT.path)" ]; then
          echo "Overall Result: $(cat $(results.SCAN_RESULT.path))"
        fi
        
        if [ -f "$(results.VULNERABILITY_COUNT.path)" ]; then
          echo "Total Vulnerabilities: $(cat $(results.VULNERABILITY_COUNT.path))"
        fi
        
        if [ -f "$(results.CRITICAL_COUNT.path)" ]; then
          echo "Critical: $(cat $(results.CRITICAL_COUNT.path))"
        fi
        
        if [ -f "$(results.HIGH_COUNT.path)" ]; then
          echo "High: $(cat $(results.HIGH_COUNT.path))"
        fi
        
        echo ""
        echo "‚úÖ Security scan completed!"

  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    runAsNonRoot: true