# Network policies for EcoTrack User Service
# Demonstrates security-focused network isolation

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: user-service-netpol
  namespace: ecotrack-dev
  labels:
    app: user-service
    app.kubernetes.io/name: user-service
    app.kubernetes.io/part-of: ecotrack
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app: user-service
  
  policyTypes:
    - Ingress
    - Egress
  
  # Ingress rules - what can connect TO this service
  ingress:
    # Allow traffic from Ambassador ingress
    - from:
        - namespaceSelector:
            matchLabels:
              name: ambassador
        - podSelector:
            matchLabels:
              service: ambassador
      ports:
        - protocol: TCP
          port: 8080
    
    # Allow traffic from other EcoTrack microservices
    - from:
        - namespaceSelector:
            matchLabels:
              name: ecotrack-dev
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: ecotrack
      ports:
        - protocol: TCP
          port: 8080
    
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: observability
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 8081
    
    # Allow health checks from Kubernetes
    - from: []
      ports:
        - protocol: TCP
          port: 8081
  
  # Egress rules - what this service can connect TO
  egress:
    # Allow DNS resolution
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # Allow connection to PostgreSQL database
    - to:
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
    
    # Allow connection to Redis cache
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    
    # Allow connection to other EcoTrack services
    - to:
        - namespaceSelector:
            matchLabels:
              name: ecotrack-dev
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: ecotrack
      ports:
        - protocol: TCP
          port: 8080
    
    # Allow connection to observability stack
    - to:
        - namespaceSelector:
            matchLabels:
              name: observability
      ports:
        - protocol: TCP
          port: 9411  # Zipkin/Tempo
        - protocol: TCP
          port: 3100  # Loki
        - protocol: TCP
          port: 9090  # Prometheus
    
    # Allow HTTPS outbound (for external APIs, if needed)
    - to: []
      ports:
        - protocol: TCP
          port: 443

---
# Deny-all default policy for the namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ecotrack-deny-all
  namespace: ecotrack-dev
  labels:
    app.kubernetes.io/name: ecotrack-deny-all
    app.kubernetes.io/part-of: ecotrack
    app.kubernetes.io/component: security
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Allow internal cluster communication for system services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-system-services
  namespace: ecotrack-dev
  labels:
    app.kubernetes.io/name: allow-system-services
    app.kubernetes.io/part-of: ecotrack
    app.kubernetes.io/component: security
spec:
  podSelector: {}
  
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Allow traffic from kube-system namespace (for health checks, etc.)
    - from:
        - namespaceSelector:
            matchLabels:
              name: kube-system
  
  egress:
    # Allow communication with kube-system services
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: TCP
          port: 443  # Kubernetes API server
        - protocol: TCP
          port: 53   # CoreDNS
        - protocol: UDP
          port: 53   # CoreDNS
    
    # Allow metadata service access (for cloud providers)
    - to: []
      ports:
        - protocol: TCP
          port: 80   # Metadata service
      
    # Allow NTP
    - to: []
      ports:
        - protocol: UDP
          port: 123