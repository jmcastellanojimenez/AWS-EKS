# 4. GitOps and Deployment Automation Manual Deployment

## Overview
GitOps deployment automation using ArgoCD and Tekton Pipelines for continuous deployment and CI/CD workflows.

## Prerequisites
- Foundation workflow completed successfully
- Ingress workflow completed successfully
- kubectl configured for the EKS cluster
- Helm 3.x installed
- Git repository with application manifests

## Components
- **ArgoCD**: GitOps continuous delivery tool
- **Tekton Pipelines**: CI/CD pipeline engine
- **Kaniko**: Container image building
- **Trivy**: Security scanning

## Manual Deployment Steps

### 1. Create ArgoCD Namespace
```bash
kubectl create namespace argocd
kubectl label namespace argocd app.kubernetes.io/managed-by=manual
```

### 2. Deploy ArgoCD
```bash
# Add ArgoCD Helm repository
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

# Deploy ArgoCD
helm install argocd argo/argo-cd \
  --namespace argocd \
  --version 5.46.7 \
  --set server.service.type=ClusterIP \
  --set server.ingress.enabled=false \
  --set controller.replicas=1 \
  --set server.replicas=2 \
  --set repoServer.replicas=2 \
  --set applicationSet.enabled=true \
  --set redis.enabled=true
```

### 3. Create Tekton Namespace
```bash
kubectl create namespace tekton-pipelines
kubectl label namespace tekton-pipelines app.kubernetes.io/managed-by=manual
```

### 4. Deploy Tekton Pipelines
```bash
# Add Tekton Helm repository
helm repo add tekton https://tektoncd.github.io/tekton-helm-charts
helm repo update

# Deploy Tekton Pipelines
helm install tekton-pipelines tekton/tekton-pipelines \
  --namespace tekton-pipelines \
  --version 0.65.1 \
  --set pipeline.replicas=1 \
  --set webhook.replicas=1
```

### 5. Wait for Tekton CRDs
```bash
# Wait for Tekton CRDs to be available
echo "Waiting for Tekton CRDs to be installed..."
while ! kubectl get crd pipelines.tekton.dev > /dev/null 2>&1; do
  echo "Waiting for pipelines.tekton.dev CRD..."
  sleep 10
done

while ! kubectl get crd tasks.tekton.dev > /dev/null 2>&1; do
  echo "Waiting for tasks.tekton.dev CRD..."
  sleep 10
done

while ! kubectl get crd taskruns.tekton.dev > /dev/null 2>&1; do
  echo "Waiting for taskruns.tekton.dev CRD..."
  sleep 10
done

while ! kubectl get crd pipelineruns.tekton.dev > /dev/null 2>&1; do
  echo "Waiting for pipelineruns.tekton.dev CRD..."
  sleep 10
done

echo "All required Tekton CRDs are now available"
```

### 6. Deploy Tekton Triggers
```bash
# Deploy Tekton Triggers
helm install tekton-triggers tekton/tekton-triggers \
  --namespace tekton-pipelines \
  --version 0.26.1 \
  --set eventlistener.replicas=1 \
  --set webhook.replicas=1
```

### 7. Configure ArgoCD Access
```bash
# Get ArgoCD admin password
kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 --decode

# Port-forward to access ArgoCD UI
kubectl port-forward svc/argocd-server 8080:443 -n argocd
```

Access ArgoCD at https://localhost:8080 (admin/password from above)

### 8. Create Sample Pipeline Resources

#### Sample Task
```bash
cat <<EOF | kubectl apply -f -
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: hello-world
  namespace: tekton-pipelines
spec:
  steps:
  - name: echo
    image: alpine:latest
    command:
    - echo
    args:
    - "Hello World from Tekton!"
EOF
```

#### Sample Pipeline
```bash
cat <<EOF | kubectl apply -f -
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: hello-pipeline
  namespace: tekton-pipelines
spec:
  tasks:
  - name: hello-task
    taskRef:
      name: hello-world
EOF
```

### 9. Create Sample ArgoCD Application
```bash
cat <<EOF | kubectl apply -f -
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sample-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/argoproj/argocd-example-apps.git
    targetRevision: HEAD
    path: guestbook
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
EOF
```

## Verification Steps

### 1. Check ArgoCD Status
```bash
kubectl get pods -n argocd
kubectl get svc -n argocd
```

### 2. Check Tekton Status
```bash
kubectl get pods -n tekton-pipelines
kubectl get crd | grep tekton
```

### 3. Test Pipeline Execution
```bash
# Create a PipelineRun
cat <<EOF | kubectl apply -f -
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: hello-pipeline-run
  namespace: tekton-pipelines
spec:
  pipelineRef:
    name: hello-pipeline
EOF

# Check pipeline execution
kubectl get pipelinerun -n tekton-pipelines
kubectl logs -f pipelinerun/hello-pipeline-run -n tekton-pipelines
```

### 4. Verify ArgoCD Application
```bash
kubectl get applications -n argocd
kubectl describe application sample-app -n argocd
```

## Configuration

### ArgoCD Repository Configuration
1. Access ArgoCD UI
2. Go to Settings > Repositories
3. Add your Git repositories:
   - Repository URL
   - Authentication credentials (if private)

### Tekton Pipeline Configuration
Create custom tasks and pipelines based on your needs:

```yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-and-push
spec:
  params:
  - name: image
    description: Reference of the image to build
  - name: dockerfile
    description: Path to the Dockerfile
    default: ./Dockerfile
  workspaces:
  - name: source
  steps:
  - name: build-and-push
    image: gcr.io/kaniko-project/executor:latest
    args:
    - --dockerfile=$(params.dockerfile)
    - --destination=$(params.image)
    - --context=/workspace/source
```

## Security Considerations

### ArgoCD Security
- Configure RBAC policies
- Use private repositories with proper authentication
- Enable audit logging
- Configure network policies

### Tekton Security
- Use service accounts with minimal permissions
- Secure secrets and credentials
- Enable admission controllers
- Use signed images

## Cost Considerations
- **ArgoCD**: Minimal cost (~$5-10/month)
- **Tekton**: Variable based on pipeline execution (~$10-20/month)
- **Storage**: Pipeline artifacts and logs (~$5-10/month)
- **Total estimated cost**: ~$20-40/month

## Troubleshooting

### ArgoCD Issues
```bash
# Check ArgoCD server logs
kubectl logs -f deployment/argocd-server -n argocd

# Check ArgoCD application controller logs
kubectl logs -f deployment/argocd-application-controller -n argocd

# Check ArgoCD repo server logs
kubectl logs -f deployment/argocd-repo-server -n argocd
```

### Tekton Issues
```bash
# Check Tekton pipeline controller logs
kubectl logs -f deployment/tekton-pipelines-controller -n tekton-pipelines

# Check Tekton webhook logs
kubectl logs -f deployment/tekton-pipelines-webhook -n tekton-pipelines

# Check specific pipeline run logs
kubectl describe pipelinerun <pipeline-run-name> -n tekton-pipelines
```

### Common Issues
1. **CRD Dependencies**: Ensure all Tekton CRDs are installed before creating resources
2. **RBAC Issues**: Verify service account permissions
3. **Network Connectivity**: Check if ArgoCD can access Git repositories
4. **Resource Limits**: Ensure sufficient cluster resources for pipeline execution

## Cleanup
```bash
helm uninstall argocd -n argocd
helm uninstall tekton-pipelines -n tekton-pipelines
helm uninstall tekton-triggers -n tekton-pipelines
kubectl delete namespace argocd
kubectl delete namespace tekton-pipelines
```

## Notes
- This setup provides basic GitOps capabilities
- Consider using ArgoCD ApplicationSets for multi-environment deployments
- Tekton pipelines can be integrated with various Git providers
- For production use, configure proper RBAC and security policies