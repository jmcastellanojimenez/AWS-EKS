# 5. Security Foundation Manual Deployment

## Overview
Comprehensive security stack including secrets management, policy enforcement, and runtime security monitoring.

## Prerequisites
- Foundation workflow completed successfully
- Ingress workflow completed successfully
- kubectl configured for the EKS cluster
- Helm 3.x installed

## Components
- **External Secrets Operator**: Kubernetes secrets management
- **OpenBao**: HashiCorp Vault alternative for secrets storage
- **OPA Gatekeeper**: Policy enforcement and compliance
- **Falco**: Runtime security monitoring and threat detection

## Manual Deployment Steps

### 1. Create Security Namespace
```bash
kubectl create namespace security
kubectl label namespace security app.kubernetes.io/managed-by=manual
```

### 2. Deploy External Secrets Operator
```bash
# Add External Secrets Helm repository
helm repo add external-secrets https://charts.external-secrets.io
helm repo update

# Deploy External Secrets Operator
helm install external-secrets external-secrets/external-secrets \
  --namespace security \
  --version 0.9.8 \
  --set installCRDs=true \
  --set resources.requests.cpu=100m \
  --set resources.requests.memory=128Mi \
  --set resources.limits.cpu=500m \
  --set resources.limits.memory=512Mi \
  --set webhook.resources.requests.cpu=100m \
  --set webhook.resources.requests.memory=128Mi \
  --set webhook.resources.limits.cpu=500m \
  --set webhook.resources.limits.memory=512Mi \
  --set certController.resources.requests.cpu=100m \
  --set certController.resources.requests.memory=128Mi \
  --set certController.resources.limits.cpu=500m \
  --set certController.resources.limits.memory=512Mi \
  --set serviceMonitor.enabled=true
```

### 3. Deploy OpenBao
```bash
# Add OpenBao Helm repository
helm repo add openbao https://openbao.github.io/openbao-helm
helm repo update

# Deploy OpenBao
helm install openbao openbao/openbao \
  --namespace security \
  --version 0.25.0 \
  --set global.enabled=true \
  --set global.tlsDisable=false \
  --set server.enabled=true \
  --set server.image.repository=quay.io/openbao/openbao \
  --set server.image.tag=2.0.0 \
  --set server.resources.requests.memory=256Mi \
  --set server.resources.requests.cpu=250m \
  --set server.resources.limits.memory=1Gi \
  --set server.resources.limits.cpu=500m \
  --set server.dataStorage.enabled=true \
  --set server.dataStorage.size=20Gi \
  --set server.dataStorage.storageClass=gp3 \
  --set server.auditStorage.enabled=true \
  --set server.auditStorage.size=10Gi \
  --set server.auditStorage.storageClass=gp3 \
  --set server.standalone.enabled=false \
  --set server.ha.enabled=true \
  --set server.ha.replicas=3 \
  --set server.service.enabled=true \
  --set server.service.type=ClusterIP \
  --set server.service.port=8200 \
  --set server.serviceMonitor.enabled=true \
  --set ui.enabled=true \
  --set ui.serviceType=ClusterIP \
  --set injector.enabled=true \
  --set injector.resources.requests.memory=256Mi \
  --set injector.resources.requests.cpu=250m \
  --set injector.resources.limits.memory=512Mi \
  --set injector.resources.limits.cpu=500m
```

### 4. Deploy OPA Gatekeeper
```bash
# Add OPA Gatekeeper Helm repository
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update

# Deploy OPA Gatekeeper
helm install gatekeeper gatekeeper/gatekeeper \
  --namespace security \
  --version 3.14.0 \
  --set replicas=3 \
  --set controllerManager.resources.requests.cpu=100m \
  --set controllerManager.resources.requests.memory=256Mi \
  --set controllerManager.resources.limits.cpu=1000m \
  --set controllerManager.resources.limits.memory=512Mi \
  --set audit.resources.requests.cpu=100m \
  --set audit.resources.requests.memory=256Mi \
  --set audit.resources.limits.cpu=1000m \
  --set audit.resources.limits.memory=512Mi \
  --set podSecurityPolicy.enabled=false \
  --set enableDeleteOperations=false \
  --set serviceMonitor.enabled=true
```

### 5. Deploy Falco
```bash
# Add Falco Helm repository
helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update

# Deploy Falco
helm install falco falcosecurity/falco \
  --namespace security \
  --version 3.8.4 \
  --set driver.kind=ebpf \
  --set collectors.enabled=true \
  --set falco.rules_file[0]=/etc/falco/falco_rules.yaml \
  --set falco.rules_file[1]=/etc/falco/falco_rules.local.yaml \
  --set falco.rules_file[2]=/etc/falco/k8s_audit_rules.yaml \
  --set falco.rules_file[3]=/etc/falco/rules.d \
  --set falco.json_output=true \
  --set falco.json_include_output_property=true \
  --set falco.json_include_tags_property=true \
  --set falco.log_stderr=true \
  --set falco.log_syslog=false \
  --set falco.log_level=info \
  --set falco.priority=debug \
  --set falco.buffered_outputs=false \
  --set falco.outputs_queue_capacity=0 \
  --set falco.outputs_timeout=2000 \
  --set falco.metrics.enabled=true \
  --set falco.metrics.interval=15s \
  --set falco.metrics.output_rule=true \
  --set falco.metrics.rules_counters_enabled=true \
  --set falco.metrics.resource_utilization_enabled=true \
  --set falco.metrics.state_counters_enabled=true \
  --set falco.metrics.kernel_event_counters_enabled=true \
  --set falco.metrics.libbpf_stats_enabled=true \
  --set falco.metrics.plugins_metrics_enabled=true \
  --set resources.requests.cpu=100m \
  --set resources.requests.memory=512Mi \
  --set resources.limits.cpu=1000m \
  --set resources.limits.memory=1Gi \
  --set serviceMonitor.enabled=true \
  --set falcosidekick.enabled=true \
  --set falcosidekick.resources.requests.cpu=100m \
  --set falcosidekick.resources.requests.memory=128Mi \
  --set falcosidekick.resources.limits.cpu=500m \
  --set falcosidekick.resources.limits.memory=512Mi
```

### 6. Wait for Gatekeeper CRDs (if creating policies)
```bash
# Wait for Gatekeeper CRDs to be available
echo "Waiting for Gatekeeper CRDs to be installed..."
while ! kubectl get crd constrainttemplates.templates.gatekeeper.sh > /dev/null 2>&1; do
  echo "Waiting for constrainttemplates.templates.gatekeeper.sh CRD..."
  sleep 10
done

echo "Gatekeeper CRDs are now available"
```

## Verification Steps

### 1. Check All Security Pods
```bash
kubectl get pods -n security
```

### 2. Check Services
```bash
kubectl get svc -n security
```

### 3. Check PVCs (for OpenBao)
```bash
kubectl get pvc -n security
```

### 4. Verify External Secrets Operator
```bash
kubectl get crd | grep external-secrets
kubectl logs -f deployment/external-secrets -n security
```

### 5. Verify OpenBao
```bash
# Port-forward to access OpenBao UI
kubectl port-forward svc/openbao 8200:8200 -n security

# Initialize OpenBao (first time only)
# Access UI at https://localhost:8200
```

### 6. Verify Gatekeeper
```bash
kubectl get constrainttemplates
kubectl get constraints
kubectl logs -f deployment/gatekeeper-controller-manager -n security
```

### 7. Verify Falco
```bash
kubectl logs -f daemonset/falco -n security
```

## Configuration

### OpenBao Initialization
```bash
# Initialize OpenBao (one-time setup)
kubectl exec -it openbao-0 -n security -- openbao operator init

# Unseal OpenBao (required after restart)
kubectl exec -it openbao-0 -n security -- openbao operator unseal <unseal-key>
```

### Sample Gatekeeper Policy
```yaml
# Required Security Context Policy
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredsecuritycontext
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredSecurityContext
      validation:
        properties:
          runAsNonRoot:
            type: boolean
          readOnlyRootFilesystem:
            type: boolean
          allowPrivilegeEscalation:
            type: boolean
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredsecuritycontext

        violation[{"msg": msg}] {
          container := input.review.object.spec.template.spec.containers[_]
          not container.securityContext.runAsNonRoot
          msg := sprintf("Container %v must run as non-root user", [container.name])
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.template.spec.containers[_]
          not container.securityContext.readOnlyRootFilesystem
          msg := sprintf("Container %v must have read-only root filesystem", [container.name])
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.template.spec.containers[_]
          container.securityContext.allowPrivilegeEscalation == true
          msg := sprintf("Container %v must not allow privilege escalation", [container.name])
        }
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredSecurityContext
metadata:
  name: must-have-security-context
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment", "DaemonSet", "StatefulSet"]
    excludedNamespaces: ["kube-system", "gatekeeper-system", "security"]
  parameters:
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
```

### Sample External Secret
```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: openbao-secret-store
  namespace: default
spec:
  provider:
    vault:
      server: "https://openbao.security.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "demo-role"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: example-secret
  namespace: default
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: openbao-secret-store
    kind: SecretStore
  target:
    name: myapp-secret
    creationPolicy: Owner
  data:
  - secretKey: password
    remoteRef:
      key: myapp
      property: password
```

## Security Best Practices

### OpenBao
- Enable audit logging
- Use least privilege access policies
- Regularly rotate root tokens
- Configure proper authentication methods

### Gatekeeper
- Start with warning mode before enforcement
- Test policies in staging environments
- Use namespaced policies where appropriate
- Monitor policy violations

### Falco
- Configure appropriate rule priorities
- Set up alerting for critical events
- Regularly update rules and signatures
- Monitor resource usage

## Cost Considerations
- **OpenBao**: Storage costs ~$5-10/month
- **Falco**: Minimal overhead ~$5/month
- **Gatekeeper**: Minimal overhead ~$3/month
- **External Secrets**: Minimal overhead ~$2/month
- **Total estimated cost**: ~$15-20/month

## Troubleshooting

### OpenBao Issues
```bash
kubectl logs -f openbao-0 -n security
kubectl describe pod openbao-0 -n security
```

### Gatekeeper Issues
```bash
kubectl logs -f deployment/gatekeeper-controller-manager -n security
kubectl describe constrainttemplate <template-name>
kubectl describe constraint <constraint-name>
```

### Falco Issues
```bash
kubectl logs -f daemonset/falco -n security
kubectl describe daemonset falco -n security
```

### External Secrets Issues
```bash
kubectl logs -f deployment/external-secrets -n security
kubectl describe externalsecret <secret-name>
```

## Cleanup
```bash
helm uninstall external-secrets -n security
helm uninstall openbao -n security
helm uninstall gatekeeper -n security
helm uninstall falco -n security
kubectl delete namespace security
```

## Notes
- OpenBao requires manual initialization and unsealing
- Gatekeeper policies should be tested before enforcement
- Falco may require tuning to reduce false positives
- Consider using AWS secrets management for simpler deployments